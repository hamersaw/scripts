#!/bin/bash

version="0.1.0"
usage="USAGE: $(basename $0) COMMAND

COMMAND:
    add <element> [OPTION...] <title>   add an element at the desired location
    help                                display this help menu
    list                                list all elements
    modify <element> [OPTION...]        update options on element
    move <element> <element>            move an element within the same level
    note <element>                      edit the element note
    remove <element>                    remove the specified element
    version                             display the application version

OPTION:
    <key>:<value>                       generic key value pair"

# id_validate(id, is_insert)
id_validate() {
    # validate regex
    if [[ ! "$1" =~ ^[0-9]+(\.[0-9]+)*$ ]]; then
        echo "invalid id '$1': invalid characters" && exit 1
    fi

    # validate id length
    local periodarray="${1//[^\.]}"
    idlength="${#periodarray}"
    if [ $idlength -gt 1 ]; then
        echo "invalid id '$1': too many values" && exit 1
    fi

    # validate list id
    if [ $idlength -eq 0 ]; then
        local listid="$1"
        local listinsert="$2"
        listrow="$1"
    elif [ $idlength -eq 1 ]; then
        local listid="${1%%\.*}"
        local listinsert=0
    fi

    listlength=$(wc -l $listfile | awk '{print $1}')
    local maxlistid=$(( listlength + listinsert ))
    if [ "$listid" -le 0 ] || [ "$listid" -gt $maxlistid ]; then
        echo "invalid list index '$listid'" && exit 1
    fi

    # read cards if list exists
    if [ $idlength -eq 0 -a $2 -eq 0 ] || [ $idlength -eq 1 ]; then
        listuuid=$(sed -n "$listid p" $listfile | awk '{print $1}')
        cards=$(awk '{print NR,$0}' $pendingfile | grep "$listuuid")
    fi

    # validate card id
    if [ $idlength -eq 1 ]; then
        if [[ "$cards" == "" ]]; then
            local firstrowindex=1
            local count=0
        else
            local firstrowindex=$(echo "$cards" | head -n 1 | awk '{print $1}')
            local count=$(echo "$cards" | wc -l)
        fi

        # validate card id
        local cardid="${1#*\.}"
        local maxcardid=$(( count + $2 ))
        if [ "$cardid" -le 0 ] || [ "$cardid" -gt $maxcardid ]; then
            echo "invalid card index '$cardid'" && exit 1
        fi

        pendingrow=$(( firstrowindex + cardid - 1))
    fi
}

# TODO - aggregate option_key and option_value to validate_option
option_key() {
    echo "${1%%:*}"
}

option_value() {
    local value="${1#*:}"

    # remove " characters from value
    if [[ "$value" =~ \".*\" ]]; then
        valuelen=${#value}
        valuelen=$(( valuelen - 2 ))
        value=${value:1:$valuelen}
    fi

    echo "$value"
}

parse_record() {
    declare -n localrecord="$2"
    while read block; do
        key=$(option_key "$block")
        value=$(option_value "$block")
        localrecord["$key"]="$value"
    done < <(echo "$1" | grep -o '[.A-Za-z]*:"[()-.A-Za-z0-9 ]*"')
}

record_to_string() {
    declare -n localrecord="$1"

    cardstring=""
    for key in $(sort -n <<<"$(printf "%s\n" "${!localrecord[@]}")"); do
        if [ "${#cardstring}" != 0 ]; then
            cardstring+=" "
        fi

        cardstring+="$key:\"${localrecord[$key]}\""
    done

    echo "[$cardstring]"
}

# initialize instance variables
datadir="$HOME/.local/share/$(basename $0)"
listfile="$datadir/list.txt"
completedfile="$datadir/completed.data"
pendingfile="$datadir/pending.data"

# if doesn't exist -> create base configuration files
[ ! -d "$datadir" ] && mkdir -p "$datadir"
[ ! -f "$listfile" ] && touch "$listfile"
[ ! -f "$completedfile" ] && touch "$completedfile"
[ ! -f "$pendingfile" ] && touch "$pendingfile"

# execute command
case "$1" in
    add)
        # check argument length
        (( $# < 3 )) && echo "'$1' requires at least two arguments" && exit 1

        # validate arguments
        id_validate "$2" "1"

        # initialize record variables
        declare -A record
        record[description]="${@: -1}"
        record[uuid]=$(cat /proc/sys/kernel/random/uuid)

        # initialize card variables
        if [ $idlength == 1 ]; then
            timestamp=$(date +%s)
            record[created]=$timestamp
            record[modified]=$timestamp
            record[listuuid]=$listuuid # TODO - abstract fieldname
        fi

        # parse options
        indexlength=$(( $# - 3 ))
        for argument in "${@:3:$indexlength}"; do
            key=$(option_key "$argument")
            value=$(option_value "$argument")

            record[$key]="$value"
        done

        # add element # TODO - abstract list and card files
        if [ $idlength == 0 ]; then
            # add list
            if [ "$listrow" -gt $listlength ]; then
                echo "${record[uuid]} ${record[description]}" >> "$listfile"
            else
                sed -i "$listrow i ${record[uuid]} ${record[description]}" "$listfile"
            fi
        elif [ $idlength == 1 ]; then
            # compile card string
            cardstring=$(record_to_string record)

            # add card at index
            pendinglength=$(wc -l $pendingfile | awk '{print $1}')
            if [ "$pendingrow" -gt $pendinglength ]; then
                echo "$cardstring" >> $pendingfile
            else
                sed -i "$pendingrow i $cardstring" $pendingfile
            fi
        fi

        echo "[+] added '$2' '${record[description]}'"
        ;;
    help)
        echo "$usage"
        ;;
    list)
        fmtstring="%-6s%-6s%-6s%s"
        printf "$fmtstring\n" "LIST" "CARD" "NOTE" "DESCRIPTION"

        # iterate over listfile
        while read listline; do
            # echo list number and description
            read -r -a listarray <<< "$listline"
            echo "${listarray[0]} ${listarray[@]:2}"

            # iterate over list cards
            cardid=1
            while read line; do
                # parse card into record associative array
                declare -A record
                parse_record "$line" record

                # check if note file exists
                notefile="$datadir/${record[uuid]}.md"
                if [ -f "$notefile" ]; then
                    noteexists="x"
                fi

                # print card
                printf "$fmtstring\n" "" "${listarray[0]}.$cardid" \
                    "$noteexists" "${record[description]}"

                # increment card id
                cardid=$(( cardid + 1 ))

                tags=""
                unset record
            done < <(cat $pendingfile | grep "${listarray[1]}")
        done < <(awk '{print NR, $0}' "$listfile")
        ;;
    modify)
        # check argument length
        (( $# < 3 )) && \
            echo "'$1' requires at least two arguments" && exit 1

        # validate arguments
        id_validate "$2" "0"
        if [ "$idlength" != 1 ]; then
            echo "'$1' command only allowed on cards" && exit 1
        fi

        # retrieve line from pendingfile
        line=$(sed -n "$pendingrow p" "$pendingfile")

        # parse and update record
        declare -A record
        parse_record "$line" record

        indexlength=$(( $# - 2 ))
        for argument in "${@:3:$indexlength}"; do
            key=$(option_key "$argument")
            value=$(option_value "$argument")

            record[$key]="$value"
        done

        record[modified]=$(date +%s)
        cardstring=$(record_to_string record)

        # replace line in pending file
        sed -i "$pendingrow c $cardstring" $pendingfile

        echo "[|] modified '$2'"
        ;;
    move)
        # check argument length
        (( $# != 3 )) && echo "'$1' requires three arguments" && exit 1

        # validate arguments
        id_validate "$2" "0"
        srcidlength="$idlength"

        # TODO - check if indices are the same level
        #if [ $srcidlength != $dstidlength ]; then
        #    echo "" && exit 1
        #fi

        if [ $srcidlength == 0 ]; then
            # move list
            srclistrow="$listrow"

            id_validate "$3" "1"
            dstlistrow="$listrow"

            # remove line from listfile
            line=$(sed -n "$srclistrow p" "$listfile")
            sed -i "$srclistrow d" "$listfile"
            listlength=$(( listlength - 1 ))

            # re-add line to listfile
            if [ "$dstlistrow" -gt $listlength ]; then
                echo "$line" >> "$listfile"
            else
                sed -i "$dstlistrow i $line" "$listfile"
            fi
        elif [ $srcidlength == 1 ]; then
            # parse pending row indices for source and destinate ids
            srcpendingrow="$pendingrow"
            srclistuuid="$listuuid"

            id_validate "$3" 1
            dstpendingrow="$pendingrow"
            dstlistuuid="$listuuid"

            # retrieve line from pendingfile
            line=$(sed -n "$srcpendingrow p" "$pendingfile")

            # parse and update record
            declare -A record
            parse_record "$line" record

            record[listuuid]=$dstlistuuid
            record[modified]=$(date +%s)

            cardstring=$(record_to_string record)

            # remove line from pendingfile
            pendinglength=$(wc -l $pendingfile | awk '{print $1}')
            sed -i "$srcpendingrow d" "$pendingfile"
            pendinglength=$(( pendinglength - 1 ))

            # re-add cardstring to pendingfile
            if [ "$srclistuuid" != "$dstlistuuid" ] && \
                    [ "$srcpendingrow" -lt "$dstpendingrow" ]; then
                dstpendingrow=$(( dstpendingrow - 1 ))
            fi

            if [ "$dstpendingrow" -gt $pendinglength ]; then
                echo "$cardstring" >> $pendingfile
            else
                sed -i "$dstpendingrow i $cardstring" $pendingfile
            fi
        fi

        echo "[|] moved '$2' to '$3'"
        ;;
    note)
        # check argument length
        (( $# != 2 )) && echo "'$1' requires one argument" && exit 1

        # validate arguments
        id_validate "$2" "0"
        if [ "$idlength" != 1 ]; then
            echo "'$1' command only allowed on cards" && exit 1
        fi

        # retrieve line from pendingfile
        line=$(sed -n "$pendingrow p" "$pendingfile")

        # parse and update record
        declare -A record
        parse_record "$line" record

        record[modified]=$(date +%s)
        cardstring=$(record_to_string record)

        # replace line in pending file
        sed -i "$pendingrow c $cardstring" $pendingfile

        # edit card note
        notefile="$datadir/${record[uuid]}.md"
        vim "$notefile"

        # if note file is empty -> remove
        if [ ! -s "$notefile" ]; then
            rm "$notefile"
        fi
        ;;
    remove)
        # check argument length
        (( $# != 2 )) && echo "'$1' requires one argument" && exit 1

        # validate arguments
        id_validate "$2" "0"

        if [ $idlength == 0 ]; then
            # check if list is empty
            if [ "$cards" != "" ]; then
                echo "list '$2' is not empty" && exit 1
            fi

            # remove line from listfile
            sed -i "$listrow d" "$listfile"
        elif [ $idlength == 1 ]; then
            # retrieve line from pendingfile
            line=$(sed -n "$pendingrow p" "$pendingfile")

            # parse and update record
            declare -A record
            parse_record "$line" record
            record[end]=$(date +%s)

            cardstring=$(record_to_string record)

            # dcheck if note file exists
            notefile="$datadir/${record[uuid]}.md"
            if [ -f "$notefile" ]; then
                rm "$notefile"
            fi

            # remove line from pendingfile
            sed -i "$pendingrow d" "$pendingfile"

            # add card to completed file
            echo "$cardstring" >> $completedfile
        fi

        echo "[-] removed '$2'"
        ;;
    version)
        echo "$version"
        ;;
    *)
        echo "$usage"
        exit 1
        ;;
esac
